h1. clj-diff

Provides <code>diff</code> and <code>patch</code> functions for Clojure sequences where <code>(diff a b) -> x</code> and <code>(patch a x) -> b</code>.

h2. Usage

<pre><code>user=> (diff "John went to the movies." "John was in the movies.")
{:+ [[5 \a \s \space \i]], :- [6 8 9 10 11]}
user=> (patch "John went to the movies." *1)
"John was in the movies."
user=> (edit-distance (diff "John went to the movies." "John was in the movies."))
9
</pre></code>

There is already a "Java library":http://code.google.com/p/google-diff-match-patch/ which does this well. Why create a Clojure version? So that we can do this:

<pre><code>user=> (def a [{:a 1} {:a 2} {:a 3} {:a 4} {:a 5} {:a 6} {:a 7}])
user=> (def b [{:a 2} {:a 3} {:a 4} {:a 5} {:a 6} {:a 7} {:a 1}])
user=> (diff a b)
{:+ [[6 {:a 1}]], :- [0]}
user=> (patch a *1)
({:a 2} {:a 3} {:a 4} {:a 5} {:a 6} {:a 7} {:a 1})
user=> (edit-distance (diff a b))
2
</code></pre>

h2. Notes

There are currently two implementations corresponding to the two papers referenced below and incorporating the optimizations from Fraser. Before reading the source code, familiarize yourself with the edit graphs and terminology in these papers.

The "Performance Tests" section below contains charts which show the performance of the different algorithms in different situations. The most interesting chart is shown here. This test run simulates a common diff scenario for various sequence lengths and illustrates the similarities in performance between the Miller and Fraser algorithms.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_5000_5.png"/>

As the charts below demonstrate, for any larger sequence, with equal or greater change, the Miller algorithm outperforms the Fraser algorithm.

h2. Installation

h3. Leiningen

Add <code>[clj-diff "1.0.0-SNAPSHOT"]</code> to your :dependencies in project.clj.

h3. Maven

Add the following dependency:

<pre><code><dependency>
  <groupId>clj-diff</groupId>
  <artifactId>clj-diff</artifactId>
  <version>1.0.0-SNAPSHOT</version>
</dependency></code></pre>

...which comes from Clojars...

<pre><code><repository>
  <id>clojars.org</id>
  <url>http://clojars.org/repo</url>
</repository></code></pre>

h2. References

* "An O(ND) Difference Algorithm and Its Variations by Eugene W. Myers":http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.4.6927&rep=rep1&type=pdf
* "An O(NP) Sequence Comparison Algorithm by Sun Wu, Udi Manber, Gene Myers and Webb Miller":http://portal.acm.org/citation.cfm?id=96223

In order to understand the above two titles, you will need to know what N, D and P stand for. Let A and B be two sequences with lengths Q and M where Q >= M. Let D be the length of the minimum edit script for A and B. In the title of the first paper N = Q + M. In the second paper N = Q and P = (1/2)D - (1/2)(Q - M). Therefore, the O(NP) version is faster which is visualized in the charts below.

* "Diff Strategies by Neil Fraser":http://neil.fraser.name/writing/diff/

h2. Performance Tests

The <code>clj-diff.performace</code> namespace contains performance tests which generate the charts below. The "Fraser":http://code.google.com/p/google-diff-match-patch/ algorithm is a good Java implementation of diff and is being used here for comparison.

h3. Results

For sequences of length 100, vary the number of mutations made to the sequence from 1 to 50. These changes will always replace existing values so that the new sequence is the same size as the old one.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/mutations_100.png"/>

For sequences of length 1000, vary the number of mutations from 1 to 500.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/mutations_1000.png"/>

Vary the length of the sequences, with 5%, 10% and 50% change.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_15000_5.png"/>

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_5000_10.png"/>

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_2000_50.png"/>

Move the first element of the sequence to the end.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_move_first_to_end.png"/>

Make a small change in the middle of the sequence.

<img src="http://s3.amazonaws.com/formpluslogic-public/images/clj-diff/length_add_in_middle.png"/>

h2. License

Copyright (C) 2010 Brenton Ashworth

Distributed under the Eclipse Public License, the same as Clojure uses. See the file COPYING.
